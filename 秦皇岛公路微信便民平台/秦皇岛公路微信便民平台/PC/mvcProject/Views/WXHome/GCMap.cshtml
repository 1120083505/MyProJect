@using Core
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>厕所分布</title>
    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css" />
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.0&key=a55451f15a2b3d3d3960e77ca01eebff&plugin=AMap.AdvancedInfoWindow,AMap.Autocomplete,AMap.PlaceSearch&plugin,AMap.AdvancedInfoWindow"></script>
    <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
    <script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
    <script src="~/Scripts/jquery-1.7.1.min.js"></script>
    <style>
        .info-title {
            color: white;
            font-size: 14px;
            background-color: #1bbc9b;
            line-height: 26px;
            padding: 0px 0 0 6px;
            font-weight: lighter;
            letter-spacing: 1px;
        }

        .info-content {
            font: 8px Helvetica, 'Hiragino Sans GB', 'Microsoft Yahei', '微软雅黑', Arial;
            padding: 4px;
            color: #666666;
            line-height: 23px;
        }

            .info-content img {
                float: left;
                margin: 3px;
            }

        .input-label {
            height: 20px;
            width: 30px;
            font-size: 12px;
        }

        .nav-button {
            height: 20px;
            width: 160px;
            font-size: 8px;
        }

        .amap-adcontent-body {
            width: 270px;
        }

        .tab {
            height: 15px;
            width: 90px;
            font-size: 12px;
        }

            .tab selected {
                height: 15px;
                width: 90px;
                font-size: 12px;
            }

        #img-Biaoz {
            height: 70px;
            width: 40px;
            float: left;
        }

        #container {
            width: 100%;
            height: 100%;
            margin: 0px;
            font-size: 13px;
        }

        #pickerBox {
            position: absolute;
            z-index: 9999;
            top: 20px;
            left: 60px;
            width: 50px;
            height: 50px;
        }

        #BiaoZ {
            position: absolute;
            z-index: 9999;
            top: 62%;
            right: 4%;
            width: 100px;
            height: 190px;
        }

            #BiaoZ img {
                position: absolute;
                z-index: 9999;
                width: 170px;
                height: 190px;
            }

        #pickerInput {
            width: 200px;
            padding: 5px 5px;
            margin-left: -54px;
        }

        #poiInfo {
            background: #fff;
        }

        .amap_lib_placeSearch .poibox.highlight {
            background-color: #CAE1FF;
        }

        .amap_lib_placeSearch .poi-more {
            display: none !important;
        }
    </style>
    <script type="text/javascript">
        //加载地图，调用浏览器定位服务


        var map;

        $(function () {
            var markers;
            map = new AMap.Map('container', {
                resizeEnable: true,
                zoom:15
            });

            AMapUI.loadUI(['misc/PoiPicker'], function(PoiPicker) {

                var poiPicker = new PoiPicker({
                    input: 'pickerInput'
                });

                //初始化poiPicker
                poiPickerReady(poiPicker);
            });

            function poiPickerReady(poiPicker) {

                window.poiPicker = poiPicker;

                var marker = new AMap.Marker();

                var infoWindow = new AMap.InfoWindow({
                    offset: new AMap.Pixel(0, -20)
                });

                //选取了某个POI
                poiPicker.on('poiPicked', function (poiResult) {
                    var source = poiResult.source,
                        poi = poiResult.item,
                        info = {
                            source: source,
                            id: poi.id,
                            name: poi.name,
                            location: poi.location.toString(),
                            address: poi.address
                        };
                    var LanLng = info.location.toString();
                    var infoWindow = new AMap.AdvancedInfoWindow({ offset: new AMap.Pixel(0, -30) });
                    $.ajax({

                        url: '@Url.Action("GetLngLat")',
                        type: 'Post',
                        //data: { lat: '31.277885', Lng: '121.359164' },
                        data: { lat: LanLng.split(',')[1], Lng: LanLng.split(',')[0] },
                        dataType: 'json',

                        success: function (d) {
                            var res = eval('(' + d + ')');
                            for (var i = 0; i < res.rows.length; i++) {
                                var marker = new AMap.Marker({
                                    
                                    //position: [maplnglat.split(',')[0], maplnglat.split(',')[1]],
                                    position: [res.rows[i].Lng, res.rows[i].Lat],
                                    icon: res.rows[i].Icon,
                                    map: map
                                });

                                var content = '<div class="info-title">' + res.rows[i].TypeID + '</div><div class="info-content">' +
                                '<div id="img-Biaoz">' + '<img src="' + res.rows[i].Icon + '">' + '</div>' +
                            '地点:' + res.rows[i].Description + '<br/>' +
                                '坑位:' + res.rows[i].Pit + '<br/></div>';
                                marker.content = content;
                                //marker.offset = new AMap.Pixel(0, -30);
                                marker.on('click', markerClick);
                                marker.emit('click', { target: marker });
                            }
                        }
                    });
                    function markerClick(e) {
                        infoWindow.setContent(e.target.content, e.target.offset);
                        infoWindow.open(map, e.target.getPosition());
                    }
                    map.setFitView();
                    marker.setMap(map);
                    infoWindow.setMap(map);
                    marker.setPosition(poi.location);
                    infoWindow.setPosition(poi.location);
                    //infoWindow.setContent('POI信息: <pre>' + JSON.stringify(info, null, 2) + '</pre>');
                    infoWindow.open(map, marker.getPosition());


                });
            }
            map.plugin('AMap.Geolocation', function () {
                geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,//是否使用高精度定位，默认:true
                    timeout: 10000,          //超过10秒后停止定位，默认：无穷大
                    buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                    zoomToAccuracy: true,      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
                    buttonPosition: 'RB'
                });
                map.addControl(geolocation);
                geolocation.getCurrentPosition();
                AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
                //AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息
            });
            function onComplete(data) {
                var infoWindow = new AMap.AdvancedInfoWindow({ offset: new AMap.Pixel(0, -30)});
               // var infoWindow = new AMap.InfoWindow({ offset: new AMap.Pixel(0, -30) });
                $.ajax({
                    url: '@Url.Action("GetLngLat")',
                    type: 'Post',
                    //data: { lat: '31.277885', Lng: '121.359164' },
                    data: { lat: data.position.getLat(),Lng:data.position.getLng()},
                    dataType: 'json',
                    success: function (d) {
                        var res = eval('(' + d + ')');
                        for (var i = 0; i < res.rows.length; i++) {
                            var marker = new AMap.Marker({
                                //position: [maplnglat.split(',')[0], maplnglat.split(',')[1]],
                                position: [res.rows[i].Lng, res.rows[i].Lat],
                                icon: res.rows[i].Icon,
                                map: map
                            });
                            var content = '<div class="info-title">' + res.rows[i].TypeID + '</div><div class="info-content">' +
                                '<div id="img-Biaoz">' + '<img src="' + res.rows[i].Icon + '">' + '</div>' +
                            '地点:' + res.rows[i].Description + '<br/>' +
                                '坑位:' + res.rows[i].Pit + '<br/></div>';

                            marker.content = content;

                            marker.on('click', markerClick);
                            marker.emit('click', { target: marker });
                        }
                    }
                });
                function markerClick(e) {
                    infoWindow.setContent(e.target.content,e.target.offset);
                    infoWindow.open(map, e.target.getPosition());
                }
                map.setFitView();
            }
           // map.clearMap();  // 清除地图覆盖物
        });
    </script>
</head>
<body>
    <div id='container'></div>
    <div id="tip"></div>
    <div class="info-tip">
        <div id="centerCoord"></div>
        <div id="tips"></div>
    </div>
    <div id="pickerBox">
        <input id="pickerInput" placeholder=" 查询" />
        <div id="poiInfo"></div>
    </div>
    @*<div id="BiaoZ">
        <img src="~/Content/images/BiaoZ.png" />
    </div>*@
</body>
