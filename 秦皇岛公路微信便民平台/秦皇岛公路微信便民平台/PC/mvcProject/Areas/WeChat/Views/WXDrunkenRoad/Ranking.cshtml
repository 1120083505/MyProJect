<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="initial-scale=1, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0, width=device-width">
    <meta name="screen-orientation" content="portrait">
    <title>评选</title>
    <link href="~/Content/zmgl/font-awesome-4.7.0/css/font-awesome.css" rel="stylesheet" />
    <link href="~/Content/zmgl/css/dropload.css" rel="stylesheet" />
    <link href="~/Content/zmgl/css/bootstrap.css" rel="stylesheet" />
    <script src="~/Content/zmgl/js/jquery.js"></script>
    <script src="~/Content/zmgl/js/bootstrap.js"></script>
    <link href="~/Content/zmgl/css/glpm.css" rel="stylesheet" />

    <style>
    </style>
</head>
<body>
    <div class="biaotou">
        <h2 style="text-align: center">排行榜</h2>
    </div>
    <div class="tabletou">
        <div class="th1">
            名次
        </div>
        <div class="th1">
            封面图
        </div>
        <div class="th1">
            编号
        </div>
        <div class="th1">
            姓名
        </div>
        <div class="th1">
            票数
        </div>
    </div>
    <div class="content">
        <div class="lists"></div>
    </div>
    <script src="~/Content/zmgl/js/dropload.min.js"></script>
    <script>
    $(function () {
        $("#pullrefresh").css("top","108px")
    })
    $(function(){
        var counter = 0;
        // 每页展示4个
        var num = 4;
        var pageStart = 0,pageEnd = 0;

        // dropload
        $('.content').dropload({
            scrollArea : window,
            loadDownFn : function(me){
                $.ajax({
                    type: 'Post',
                    url: '@Url.Action("GetPMList")',
                    dataType: 'json',
                    success: function(data){
                        var result = '';
                        counter++;
                        pageEnd = num * counter;
                        pageStart = pageEnd - num;
                        //alert(JSON.stringify(data));
                        for (var i = pageStart; i < pageEnd; i++) {
                            img = data.rows[i].Ext1;
                            if (img == '' | img == null) {
                                img = "/Content/images/1.jpg";
                            }
                            var mingci = i + 1;
                            result +=   '<div class="biao" style="width: 100%;height: 90px;" data-toggle="modal" data-target="#myModal'+ i +'">'+
                                '<div class="th1">' + mingci + '</div>' +
                                '<div class="th1"><img src="' + img + '"/>' +

                                '</div>'+
                                '<div class="th1">' + data.rows[i].PlayerNum + '</div>'+
                                '<div class="th1">' + data.rows[i].PlayerName +  '</div>'+
                                '<div class="th1">' + data.rows[i].PlayerVotes +  '</div>'+
                                '</div>'+
                                '<div class="modal fade" id="myModal'+ i +'" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">'+
                                '<div class="modal-dialog" role="document">'+
                                '<div class="modal-content">'+
                                '<div class="modal-header">'+
                                '<button type="button" class="close" data-dismiss="modal" aria-label="Close">'+
                                '<span aria-hidden="true">×</span>  '+
                                '</button>  '+
                                '</div>  '+
                                '<div class="modal-body">'+
                                '<div style="position: relative;">' +
                                '<img src="' + img + '" style="width: 100%;" alt="">' +
                                '<div style="position: absolute;width: 100%;height: 40px;bottom: 0;background: rgba(0, 0, 0, 0.5);">' +
                                '<div style="height: 100%;float: left;line-height: 40px;color: #fff;margin-left: 11px;">&nbsp;' + data.rows[i].PlayerNum + '&nbsp;号&nbsp;&nbsp;&nbsp;' + data.rows[i].PlayerName + '' +
                                '</div>'+
                                '<div style="line-height: 40px;color: #fff;height: 100%;float: right;margin-right: 11px">' + data.rows[i].PlayerVotes + '票' +
                                '</div>'+
                                '</div>'+
                                '</div>'+

                                '</div>  '+
                                '<div class="modal-footer" style="text-align:left">'+
                                '<div>' +
                                '<p><span class="fa fa-quote-left" style="color: #969696;"></span>' + data.rows[i].PlayerMemo + '<span class="fa fa-quote-right" style="color: #969696;"></span>' +
                                '</p>'+
                                '</div>'+
                                '<button type="button" class="btn btn-default fa fa-heart" id="' + data.rows[i].Id + '" onclick="Vote(this.id)" style="display: table-cell;background: #FE5037;color: #fff;">&nbsp;&nbsp;给它投票</button>  ' +
                                '<div style="width: auto;float: right;color: #FE5037;">' +
                                '<span class="fa fa-share-alt" style="margin-right: 10px">' +
                                '</span>为它拉票'+
                                '</div>'+
                                '</div>  '+
                                '</div>  '+
                                '</div>  '+
                                '</div> ';
                            if ((i + 1) >= data.rows.length) {
                                // 锁定
                                me.lock();
                                // 无数据
                                me.noData();
                                break;
                            }
                        }
                        // 为了测试，延迟1秒加载
                        setTimeout(function(){
                            $('.lists').append(result);
                            // 每次数据加载完，必须重置
                            me.resetload();
                        },1000);
                    },
                    error: function(xhr, type){
                        alert('Ajax error!');
                        // 即使加载出错，也得重置
                        me.resetload();
                    }
                });
            }
        });
    });
        function Vote(Id) {
            //alert(Id);
            $.ajax({
                url: '@Url.Action("Vote")',
                data: { Id: Id },
                type: 'Post',
                //dataType: 'json',
                async: false,
                success: function (dataResult) {
                    if (dataResult == "OK") {
                        alert("投票成功");
                        //刷新页面
                        location.reload();

                    }
                    if (dataResult == "Repeat") {
                        alert("您今天已经投过票了！");
                    }

                }
            })
        };
    </script>
</body>
</html>